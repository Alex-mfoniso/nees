<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Product List</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css"
      rel="stylesheet"
    />
    <style>
      /* Spinner in table row */
      .table-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }
      .table-spinner div {
        border: 6px solid #f3f3f3;
        border-top: 6px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <aside class="sidebar">
        <div class="logo">
          <!-- <img src="https://via.placeholder.com/40x40?text=Logo" alt="Neelsolar Logo" /> -->
          <span>NEESOLAR</span>
        </div>
        <nav class="main-nav">
          <ul>
            <li>
              <a href="index.html"><i class="fas fa-th-large"></i> Dashboard</a>
            </li>
            <li>
              <a href="add-new-product.html"
                ><i class="fas fa-plus-circle"></i> Add Products</a
              >
            </li>
            <li class="active">
              <a href="products.html"
                ><i class="fas fa-box-open"></i> Product Stock</a
              >
            </li>
            <li>
              <a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </li>
          </ul>
        </nav>
      </aside>

      <main class="main-content">
        <header class="">
          <button class="hamburger-btn" id="hamburger">
            <i class="fas fa-bars"></i>
          </button>
         
        </header>

        <div class="product-list-card card">
          <div class="card-header-actions">
            <h1>Products List</h1>
            <div class="action-buttons">
              <!-- <button class="btn btn-secondary">Import</button> -->
              <!-- <button class="btn btn-secondary">Export</button> -->
              <!-- <button class="btn btn-primary"><i class="fas fa-plus"></i> Add Product</button> -->
            </div>
          </div>

          <div class="table-container">
            <table id="productTable" class="display" style="width: 100%">
              <thead>
                <tr>
                  <th>Product Image</th>
                  <th>Product Name</th>
                  <th>Category</th>
                  <th>Current Qty</th>
                  <th>Price</th>
                  <th>Status</th>
                  <th>Option</th>
                </tr>
              </thead>
              <tbody id="productTableBody">
                <tr id="loadingRow">
                  <td colspan="7" class="table-spinner">
                    <div></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <!-- Edit Product Modal -->
    <div
      class="modal fade"
      id="editProductModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="editProductForm">
            <div class="modal-header">
              <h5 class="modal-title">Edit Product</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="editProductId" name="id" />
              <div class="mb-3">
                <label for="editProductName" class="form-label">Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="editProductName"
                  name="name"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editProductPrice" class="form-label">Price</label>
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  id="editProductPrice"
                  name="price"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editProductQuantity" class="form-label"
                  >Quantity</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="editProductQuantity"
                  name="quantity"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editProductAvailability" class="form-label"
                  >Availability</label
                >
                <select
                  class="form-select"
                  id="editProductAvailability"
                  name="availability"
                >
                  <option value="Approved">Approved</option>
                  <option value="Pending">Pending</option>
                  <option value="Out of Stock">Out of Stock</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
              <button type="submit" class="btn btn-primary">
                Save changes
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.js"></script>

    <script>
      const backendUrl = "https://nees-1.onrender.com";
      const token = localStorage.getItem("token");

      // Auth check
      (function () {
        if (!token) return (window.location.href = "admin-login.html");
        try {
          const decoded = jwt_decode(token);
          if (Date.now() > decoded.exp * 1000) {
            localStorage.removeItem("token");
            window.location.href = "admin-login.html";
          }
        } catch (e) {
          localStorage.removeItem("token");
          window.location.href = "admin-login.html";
        }
      })();

      async function loadProducts() {
        const tableBody = document.getElementById("productTableBody");
        try {
          // Show spinner
          tableBody.innerHTML = `<tr id="loadingRow"><td colspan="7" class="table-spinner"><div></div></td></tr>`;
          const res = await fetch(`${backendUrl}/api/products`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) throw new Error("Failed to fetch products.");
          const products = await res.json();

          // Clear table
          tableBody.innerHTML = "";

          products.forEach((product) => {
            const availability = product.availability || "In Stock";
            const tr = document.createElement("tr");
            tr.id = `row-${product.id}`;
            tr.innerHTML = `
    <td>
        <img src="${product.thumbnail || "/placeholder.svg"}" 
             class="img-fluid" 
             alt="product"
             style="max-width: 50px; height: auto;" />
    </td>
    <td>${product.name}</td>
            <td>${product.category || ""}</td>
            <td>${product.quantity || 0}</td>
            <td>â‚¦${(+product.price || 0).toFixed(2)}</td>
            <td class="${
              availability === "In Stock"
                ? "status-available"
                : "status-unavailable"
            }">${availability}</td>
            <td>
              <ul class="option-links">
                <li><a href="javascript:void(0)" onclick='openEditModal(${JSON.stringify(
                  product
                )})'><i class="ri-pencil-line"></i></a></li>
                <li><a href="javascript:void(0)" onclick="deleteProduct('${
                  product.id
                }')"><i class="ri-delete-bin-line"></i></a></li>
              </ul>
            </td>
          `;
            tableBody.appendChild(tr);
          });

          if ($.fn.DataTable.isDataTable("#productTable")) {
            $("#productTable").DataTable().destroy();
          }
          $("#productTable").DataTable();
        } catch (err) {
          tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">Error loading products</td></tr>`;
          console.error(err);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadProducts();
      });

      async function deleteProduct(id) {
        if (!confirm("Are you sure?")) return;
        try {
          const res = await fetch(`${backendUrl}/api/products/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) throw new Error("Failed to delete product.");
          document.getElementById(`row-${id}`).remove();
        } catch (err) {
          alert(err.message);
        }
      }

      function openEditModal(product) {
        document.getElementById("editProductId").value = product.id;
        document.getElementById("editProductName").value = product.name;
        document.getElementById("editProductPrice").value = product.price;
        document.getElementById("editProductQuantity").value =
          product.quantity || 0;
        document.getElementById("editProductAvailability").value =
          product.availability || "In Stock";
        const modal = new bootstrap.Modal(
          document.getElementById("editProductModal")
        );
        modal.show();
      }

      document
        .getElementById("editProductForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const id = document.getElementById("editProductId").value;
          const formData = new FormData(e.target);
          try {
            const res = await fetch(`${backendUrl}/api/products/${id}`, {
              method: "PUT",
              headers: { Authorization: `Bearer ${token}` },
              body: formData,
            });
            if (!res.ok) throw new Error("Failed to update product.");
            await loadProducts();
            bootstrap.Modal.getInstance(
              document.getElementById("editProductModal")
            ).hide();
          } catch (err) {
            alert(err.message);
          }
        });

      document
        .getElementById("hamburger")
        .addEventListener("click", function () {
          document.querySelector(".sidebar").classList.toggle("show");
        });
    </script>
